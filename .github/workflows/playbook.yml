name: Techbleat Capstone Pipeline
on: [push]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. SECURITY SCANS (Local)
      - name: Run Bandit (Local SAST)
        run: |
          pip install bandit 
          bandit -r ./app || true 

      # 2. TERRAFORM (Infrastructure)
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v4
        with:
          terraform_wrapper: false 

      - name: Terraform Init & Apply
        id: tf
        run: |
          cd terraform
          terraform init
          terraform apply -auto-approve -var="db_password=${{ secrets.DB_PASSWORD }}"
          
          echo "BASTION_IP=$(terraform output -raw bastion_public_ip)" >> $GITHUB_ENV
          echo "BACKEND_IP=$(terraform output -raw backend_private_ip)" >> $GITHUB_ENV
          echo "RDS_ENDPOINT=$(terraform output -raw rds_endpoint)" >> $GITHUB_ENV
          echo "DB_NAME=$(terraform output -raw db_name)" >> $GITHUB_ENV
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      # 3. PREPARE OFFLINE DEPENDENCIES
      - name: Download Pip Wheels
        run: |
          mkdir -p dependencies
          pip download --dest ./dependencies \
            --platform manylinux2014_x86_64 \
            --python-version 3.9 \
            --implementation cp \
            --only-binary=:all: \
            -r requirements.txt \
            exceptiongroup typing-extensions sniffio

      - name: Download Node Exporter for Offline Install
        run: |
          mkdir -p downloads
          wget -P downloads/ https://github.com/prometheus/node_exporter/releases/download/v1.7.0/node_exporter-1.7.0.linux-amd64.tar.gz      

      # 4. ANSIBLE CONFIGURATION (The Deployment)
      - name: Setup SSH Key
        run: |
          printf "%s" "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > key.pem
          chmod 400 key.pem

      - name: Create the dynamic inventory and Run Playbook
        run: |
          echo "[web]" > inventory.ini
          echo "bastion ansible_host=${{ env.BASTION_IP }} ansible_user=ec2-user ansible_ssh_private_key_file=key.pem" >> inventory.ini
          
          echo "" >> inventory.ini
          echo "[backend]" >> inventory.ini
          # We use the Internal IP for the backend
          echo "app_server ansible_host=${{ env.BACKEND_IP }} ansible_user=ec2-user ansible_ssh_private_key_file=key.pem" >> inventory.ini
          
          echo "" >> inventory.ini
          echo "[all:vars]" >> inventory.ini
          # FIX: This line uses double quotes for the variable and single quotes for the internal SSH command
          echo "ansible_ssh_common_args='-o ProxyCommand=\"ssh -i key.pem -W %h:%p -q -o StrictHostKeyChecking=no ec2-user@${{ env.BASTION_IP }}\"'" >> inventory.ini

          export ANSIBLE_HOST_KEY_CHECKING=False
          ansible-playbook -i inventory.ini ansible/master.yml \
            --extra-vars "rds_endpoint=${{ env.RDS_ENDPOINT }} db_password=${{ secrets.DB_PASSWORD }} db_name=${{ env.DB_NAME }} backend_ip=${{ env.BACKEND_IP }} bastion_ip=${{ env.BASTION_IP }}"

      # 5. POST-DEPLOYMENT SMOKE TEST
      - name: Smoke Test
        run: |
          echo "Checking app health via Bastion..."
          ssh -i key.pem -o StrictHostKeyChecking=no \
            -o ProxyCommand="ssh -i key.pem -W %h:%p -q -o StrictHostKeyChecking=no ec2-user@${{ env.BASTION_IP }}" \
            ec2-user@${{ env.BACKEND_IP }} "curl -s -o /dev/null -w '%{http_code}' http://localhost:8000/healthz" > status_code.txt
          
          STATUS=$(cat status_code.txt)
          echo "App returned status: $STATUS"
          if [ "$STATUS" == "200" ]; then
            echo "SUCCESS: App is healthy!"
          else
            echo "FAILURE: App returned status $STATUS"
            exit 1
          fi

      # 6. REPORTING & ARTIFACTS
      - name: Download Scan Report
        if: always() 
        run: |
          ssh -i key.pem -o StrictHostKeyChecking=no \
            -o ProxyCommand="ssh -i key.pem -W %h:%p -q -o StrictHostKeyChecking=no ec2-user@${{ env.BASTION_IP }}" \
            ec2-user@${{ env.BACKEND_IP }} "cat /tmp/scan_report.txt" > vulnerability_report.txt || echo "Report not found"

      - name: Upload Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Techbleat-Vulnerability-Report
          path: vulnerability_report.txt

      # 7. DEBUG LOGS (Only runs on failure)
      - name: Capture Backend Logs on Failure
        if: failure()
        run: |
          ssh -i key.pem -o StrictHostKeyChecking=no \
            -o ProxyCommand="ssh -i key.pem -W %h:%p -q -o StrictHostKeyChecking=no ec2-user@${{ env.BASTION_IP }}" \
            ec2-user@${{ env.BACKEND_IP }} "tail -n 50 /home/ec2-user/app/app.log" || echo "Log not found"