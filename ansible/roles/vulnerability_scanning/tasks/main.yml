---
- name: Ensure SSH key is on Bastion for remote scanning
  copy:
    src: key.pem
    dest: /home/ec2-user/key.pem
    mode: '0400'
  delegate_to: bastion

- name: Install scanning tools ON BASTION
  delegate_to: bastion
  dnf:
    name: python3-pip
    state: present
  become: true

- name: Install Bandit and Safety ON BASTION
  delegate_to: bastion
  pip:
    name: [bandit, safety]
    state: present
    executable: pip3
  become: true

- name: Run Remote Bandit Scan from Bastion
  delegate_to: bastion
  shell: |
    ssh -i /home/ec2-user/key.pem -o StrictHostKeyChecking=no ec2-user@{{ ansible_host }} \
    "bandit -r /home/ec2-user/app -f screen"
  register: bandit_result
  ignore_errors: yes

- name: Run Remote Safety Check from Bastion
  delegate_to: bastion
  shell: |
    ssh -i /home/ec2-user/key.pem -o StrictHostKeyChecking=no ec2-user@{{ ansible_host }} \
    "safety check -r /home/ec2-user/app/requirements.txt"
  register: safety_result
  ignore_errors: yes

- name: Create Unified Scan Report on Backend
  copy:
    dest: /tmp/scan_report.txt
    content: |
      === VULNERABILITY SCAN REPORT ===
      Generated on: {{ ansible_facts['date_time']['iso8601'] }}
      
      --- BANDIT SAST OUTPUT ---
      {{ bandit_result.stdout | default('No Bandit output') }}
      
      --- SAFETY CHECK OUTPUT ---
      {{ safety_result.stdout | default('No Safety output') }}
  become: true