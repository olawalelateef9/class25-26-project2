---
- name: Ensure SSH key is on Bastion for remote scanning
  copy:
    src: "{{ playbook_dir }}/../key.pem"
    dest: "/home/ec2-user/key.pem"
    mode: '0400'
  delegate_to: bastion

- name: Install scanning tools ON BASTION
  delegate_to: bastion
  dnf:
    name: python3-pip
    state: present
  become: true

- name: Install Bandit and Safety ON BASTION
  delegate_to: bastion
  pip:
    name: [bandit, safety]
    state: present
    executable: pip3
  become: true

- name: Run Bandit Scan from Bastion against Backend code
  delegate_to: bastion
  shell: |
    rsync -avz -e "ssh -i /home/ec2-user/key.pem -o StrictHostKeyChecking=no" ec2-user@{{ ansible_host }}:/home/ec2-user/app/ /tmp/app_to_scan/
    bandit -r /tmp/app_to_scan -f screen
  register: bandit_result
  ignore_errors: yes

- name: Run Safety check from Bastion against Backend requirements
  delegate_to: bastion
  shell: |
    scp -i /home/ec2-user/key.pem -o StrictHostKeyChecking=no ec2-user@{{ ansible_host }}:/home/ec2-user/app/requirements.txt /tmp/requirements.txt
    safety check -r /tmp/requirements.txt
  register: safety_result
  ignore_errors: yes

- name: Create Unified Scan Report on Backend
  copy:
    dest: /tmp/scan_report.txt
    content: |
      === VULNERABILITY SCAN REPORT ===
      Generated on: {{ ansible_facts['date_time']['iso8601'] }}
      
      --- BANDIT SAST OUTPUT ---
      {{ bandit_result.stdout | default('Bandit scan failed or no output') }}
      
      --- SAFETY DEPENDENCY OUTPUT ---
      {{ safety_result.stdout | default('Safety scan failed or no output') }}
  become: true

- name: Cleanup Bastion temporary files
  delegate_to: bastion
  file:
    path: "{{ item }}"
    state: absent
  with_items:
    - "/tmp/app_to_scan"
    - "/tmp/requirements.txt"