---
- name: Ensure pip3 is installed for scanning tools
  dnf:
    name: python3-pip
    state: present

- name: Ensure scanning tools are installed
  pip:
    name: 
      - bandit
      - safety
    state: present

- name: Run Bandit SAST scan
  shell: "bandit -r /home/ec2-user/app -f screen"
  register: bandit_result
  ignore_errors: yes

- name: Run Safety dependency check
  shell: |
    # Ensure we are pointing to the actual location on the backend
    safety check -r /home/ec2-user/app/requirements.txt
  delegate_to: 10.0.2.8  # Force this specific task to run on the Backend
  become: true
  ignore_errors: yes

- name: Display Scan Results in Console
  debug:
    msg: 
      - "--- BANDIT SAST RESULTS ---"
      - "{{ bandit_result.stdout_lines }}"
      - "--- SAFETY DEPENDENCY RESULTS ---"
      - "{{ safety_result.stdout_lines }}"

- name: Create Unified Scan Report File
  copy:
    dest: /tmp/scan_report.txt
    content: |
      === VULNERABILITY SCAN REPORT ===
      Generated on: {{ ansible_date_time.iso8601 }}
      
      --- BANDIT SAST OUTPUT ---
      {{ bandit_result.stdout }}
      
      --- SAFETY CHECK OUTPUT ---
      {{ safety_result.stdout }}
