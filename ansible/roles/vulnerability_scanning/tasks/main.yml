---
- name: Ensure Backend is still reachable
  wait_for_connection:
    timeout: 60

- name: Ensure python3-pip is installed
  dnf:
    name: python3-pip
    state: present
  become: true

- name: Install scanning tools
  pip:
    name: 
      - bandit
      - safety
    state: present
    executable: pip3
  become: true

- name: Run Bandit SAST scan
  shell: "bandit -r /home/ec2-user/app -f screen"
  register: bandit_result
  ignore_errors: yes

- name: Run Safety dependency check
  shell: "safety check -r /home/ec2-user/app/requirements.txt"
  register: safety_result
  ignore_errors: yes

- name: Display Scan Results in Console
  debug:
    msg: 
      - "--- BANDIT SAST RESULTS ---"
      - "{{ bandit_result.stdout_lines | default(['Bandit failed']) }}"
      - "--- SAFETY DEPENDENCY RESULTS ---"
      - "{{ safety_result.stdout_lines | default(['Safety failed']) }}"

- name: Create Unified Scan Report File
  copy:
    dest: /tmp/scan_report.txt
    content: |
      === VULNERABILITY SCAN REPORT ===
      Generated on: {{ ansible_facts['date_time']['iso8601'] }}
      
      --- BANDIT SAST OUTPUT ---
      {{ bandit_result.stdout | default('No Bandit output') }}
      
      --- SAFETY CHECK OUTPUT ---
      {{ safety_result.stdout | default('No Safety output') }}
  become: true