---
- name: Ensure pip3 is installed for scanning tools
  dnf:
    name: python3-pip
    state: present

- name: Ensure scanning tools are installed
  pip:
    name: 
      - bandit
      - safety
    state: present

- name: Run Bandit SAST scan
  # Running on the backend where the /app folder actually is
  shell: "bandit -r /home/ec2-user/app -f screen"
  register: bandit_result
  ignore_errors: yes

- name: Run Safety dependency check
  # Running on the backend to find the requirements.txt
  shell: "safety check -r /home/ec2-user/app/requirements.txt"
  register: safety_result
  ignore_errors: yes

- name: Display Scan Results in Console
  debug:
    msg: 
      - "--- BANDIT SAST RESULTS ---"
      - "{{ bandit_result.stdout_lines | default(['Bandit found no files or failed']) }}"
      - "--- SAFETY DEPENDENCY RESULTS ---"
      - "{{ safety_result.stdout_lines | default(['Safety found no files or failed']) }}"

- name: Create Unified Scan Report File
  copy:
    dest: /tmp/scan_report.txt
    content: |
      === VULNERABILITY SCAN REPORT ===
      Generated on: {{ ansible_facts['date_time']['iso8601'] }}
      
      --- BANDIT SAST OUTPUT ---
      {{ bandit_result.stdout | default('No Bandit output') }}
      
      --- SAFETY CHECK OUTPUT ---
      {{ safety_result.stdout | default('No Safety output') }}