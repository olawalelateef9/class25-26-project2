---
- name: Kill anything using port 8000
  shell: "fuser -k 8000/tcp || true"
  become: true
  ignore_errors: yes

- name: Wait for port 8000 to be completely free
  wait_for:
    port: 8000
    state: absent
    timeout: 30

- name: Install Python3-pip
  dnf:
    name: python3-pip
    state: present
  become: true

- name: Create app directory
  file:
    path: /home/ec2-user/app
    state: directory
    owner: ec2-user
    group: ec2-user
    mode: '0755'

- name: Clean and Transfer App, Requirements, and Wheels
  copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    owner: ec2-user
    group: ec2-user
    mode: '0755'
    force: yes
  with_items:
    - { src: "{{ playbook_dir }}/../app/", dest: "/home/ec2-user/app/" }
    - { src: "{{ playbook_dir }}/../requirements.txt", dest: "/home/ec2-user/app/requirements.txt" }
    - { src: "{{ playbook_dir }}/../dependencies/", dest: "/home/ec2-user/app/dependencies/" }

- name: Install App dependencies Offline
  shell: |
    python3 -m pip install --user --no-index \
      --find-links=/home/ec2-user/app/dependencies/ \
      -r /home/ec2-user/app/requirements.txt
  become_user: ec2-user

- name: Start FastAPI in background
  shell: |
    cd /home/ec2-user/app
    # Use the local variable alias to avoid 'undefined' errors
    export DATABASE_URL="postgresql://{{ local_db_user }}:{{ db_password }}@{{ rds_endpoint.split(':')[0] }}:5432/{{ db_name }}"
    export PYTHONPATH=$PYTHONPATH:.
    
    if [ -d "app" ]; then
        nohup /usr/bin/python3 -m uvicorn app.main:app --host 0.0.0.0 --port 8000 > app.log 2>&1 &
    else
        nohup /usr/bin/python3 -m uvicorn main:app --host 0.0.0.0 --port 8000 > app.log 2>&1 &
    fi
  vars:
    # This is the "Safety Net" that fixes the error
    local_db_user: "{{ db_user | default('postgres') }}"
  async: 60
  poll: 0
  become_user: ec2-user

- name: Wait for FastAPI (Health Check)
  uri:
    url: "http://localhost:8000/healthz"
    status_code: 200
  register: result
  until: result.status == 200
  retries: 15
  delay: 5
  ignore_errors: yes

- name: Capture App Logs on Failure
  command: tail -n 20 /home/ec2-user/app/app.log
  register: app_logs
  when: result.status is not defined or result.status != 200
  ignore_errors: yes

- name: Display App Logs on Failure
  debug:
    var: app_logs.stdout_lines
  when: result.status is not defined or result.status != 200

- name: Final Validation
  fail:
    msg: "FastAPI failed to start. Review the logs displayed above."
  when: result.status is not defined or result.status != 200