---
- name: Install Python3-pip
  dnf:
    name: python3-pip
    state: present

- name: Create app directory
  file:
    path: /home/ec2-user/app
    state: directory
    owner: ec2-user
    group: ec2-user
    mode: '0755'

- name: Transfer App code from Runner to Backend
  # Using "{{ playbook_dir }}" ensures we start from the 'ansible/' folder
  # then go up one level to find 'app/' at the root
  copy:
    src: "{{ playbook_dir }}/../app/"
    dest: /home/ec2-user/app/
    owner: ec2-user
    group: ec2-user
    mode: '0755'

- name: Install App dependencies
  pip:
    requirements: /home/ec2-user/app/requirements.txt
    executable: pip3
    extra_args: "--user"
  become: true
  become_user: ec2-user

- name: Kill existing FastAPI processes
  shell: pkill -f "uvicorn" || true
  ignore_errors: yes    

- name: Start FastAPI in background
  shell: |
    cd /home/ec2-user/app
    # Using split to handle the endpoint:port formatting correctly
    export DATABASE_URL="postgresql://{{ db_user }}:{{ db_password }}@{{ rds_endpoint.split(':')[0] }}:5432/{{ db_name }}"
    nohup /usr/bin/python3 -m uvicorn app.main:app --host 0.0.0.0 --port 8000 > app.log 2>&1 &
  async: 60
  poll: 0
  become_user: ec2-user

- name: Wait for FastAPI to start (Health Check)
  uri:
    url: "http://localhost:8000/"
    status_code: 200
  register: result
  until: result.status == 200
  retries: 15
  delay: 5