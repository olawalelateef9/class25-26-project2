---
# 1. First, harden the Bastion (web) so the "bridge" is secure
- name: Apply Hardening to Bastion
  hosts: web
  become: true
  roles:
    - role: os_hardening

# 2. Then, harden the Backend
- name: Apply Hardening to Backend
  hosts: backend
  become: true
  roles:
    - role: os_hardening

# 3. Proceed with configurations
- name: Deploy Database tier
  hosts: backend
  become: true
  roles:
    - { role: db_servers, tags: ["db"] }

- name: Deploy Application Tier
  hosts: backend
  become: true
  roles:
    - { role: app_servers, tags: ["app"] }

# 4. Final Scans - Targeted specifically to the Backend
- name: Apply Vulnerability Scanning
  hosts: backend  # <--- Changed from 'all' to 'backend'
  become: true
  roles:
    - { role: vulnerability_scanning, tags: ["vulnerability"] }

  post_tasks:
    - name: Fetch vulnerability report to GitHub Runner
      fetch:
        src: /tmp/scan_report.txt
        dest: ./vulnerability_report.txt
        flat: yes